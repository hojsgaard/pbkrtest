---
title: "Untitled"
author: "Søren Højsgaard"
date: "`r Sys.Date()`"
format: 
  html: 
    toc: true
    number-sections: true
    self-contained: true
---

\def\cov{Cov}
\def\corr{Corr}
\def\var{Var}
\def\nn{\nonumber}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
options("digits"=4)
```

\def\fixme#1{{\color{red}#1}}

## Preliminaries

To carry out the examples in this note, make sure the following
packages from CRAN are installed: lme4, nlme, SASmixed,

```{r print=F}
library(lme4)
library(nlme)
library(SASmixed)
library(doBy)
library(dataRep)
library(tidyr)
library(ggplot2)
library(pbkrtest)
library(knitr)
library(broom.mixed)
```

## Shoes

The shoes data are measurements of the amount wear of the soles of
shoes worn by 10 boys. The soles were made to two different synthetic
materials, a standard material A and a cheaper material B. Data is
taken from Box, Hunter, Hunter (2005) Statistics for Experimenters,
2nd edition Wiley, p. 81.

```{r}
data(shoes, package="doBy")
shoes_comp <- shoes
kable(shoes_comp)
shoes_long <-
    shoes |> pivot_longer(cols=c("A", "B"), names_to="type", values_to = "wear")
shoes_long <- na.omit(shoes_long)
kable(shoes_long)
```


```{r}
source("nlme.R")
data("Orthodont")


 .get_refdist_gls <- function(lg, sm, nsim=20, seed=NULL,
                    simdata=simulate(sm, nsim=nsim, seed=NULL)){
    
    ## simdata |>  print()
    val <- list()
    for (i in 1:ncol(simdata)){
        yyy <- simdata[,i]
        sm2 <- refit_gls(sm, yyy)
        lg2 <- refit_gls(lg, yyy)
        
        lsm <- logLik(sm2, REML=FALSE)
        llg <- logLik(lg2, REML=FALSE)
        v <- c(llg, lsm, 2*(llg-lsm))
        val <- c(val, list(v))
    }
    
    val <- do.call(rbind, val)
    val[,3]    
}



orth <- Orthodont##[c(1:12, 97:108),]



source("get_vary.r")
                                        # Fit the gls model
model <- gls(wear ~ type, 
             correlation = corCompSymm(form = ~ 1 | boy), 
             method = "ML",
             data = shoes_long)

get_vary(model)

get_vary(model) |> image()

model  <- lmer( wear ~ type + (1|boy), data=shoes_long, REML=F)
load_all("_pbkrtest")
pbkrtest:::get_matrices_from_lmer(model)

get_vary(model)
get_vary(model) |> image()

model <- lme(distance ~ age, random = ~ age | Subject, 
                 correlation = corAR1(form = ~ 1 | Subject), data = Orthodont, method="ML")

get_vary(model)
get_vary(model) |> image()


getVarCov(model2)

get_vary(model)
get_vary(model) |> image()


fm1 <- lme(distance ~ age, data = Orthodont, subset = Sex == "Female")
getVarCov(fm1)
getVarCov(fm1, individual = "F01", type = "marginal")
 getVarCov(fm1, type = "conditional")
fm2 <- gls(follicles ~ sin(2*pi*Time) + cos(2*pi*Time), Ovary,
           correlation = corAR1(form = ~ 1 | Mare))
getVarCov(fm2)




source("get_vary.r")

orth <- Orthodont#[order(sample(88, replace=F)),]

model1  <- lmer(distance ~ Sex + age + (age|Subject), data=Orthodont, REML=F)
model2 <- lme(distance ~ Sex + age, random = ~ age | Subject, 
                 data = Orthodont, method="ML")

model <- model2
data <- Orthodont

gf <- nlme::getGroupsFormula(model)
gf <- deparse(gf[[2]])


ss <- getData(model)|> group_by_at(gf) |> group_split()
ss


ss <- Orthodont|> split_by(gf)

bb <- lapply(levels(Orthodont$Subject), function(s){
    print(s)
    print(as.character(s))
    print(ss[[s]])
    model.matrix(model$modelStruct$reStruc, data=ss[[as.character(s)]])
    }
    )



rn <- as.numeric(rownames(do.call(rbind, bb)))

bb <- lapply(ss, function(s)
    model.matrix(model$modelStruct$reStruc, data=s)
    )

bb <- bdiag(bb)


getME(model1, "Z")[1:20,]

bb[order(rn), ][1:20,]


Z <- model.matrix(model$modelStruct$reStruc,
                  data = dfL.data[dfL.data$id=="1",])



getVarCov(model, type = "marginal")





source("get_vary.r")
ZZ <- reconstruct_Z_lme(model2, Orthodont)
dim(ZZ)
head(ZZ, 12)

ZZZ <- as(model.matrix(~ -1 + Subject + age : Subject, data=Orthodont), "sparseMatrix")

library(nlme)

# Fit an example model
data(Orthodont, package = "nlme")
model <- lme(distance ~ Sex + age, random = ~ age | Subject, data = Orthodont, method = "ML")

source("get_vary.r")
V <- get_full_covariance_lme(model)$V
V[1:8, 1:8]

get_vary(model1)[1:8, 1:8]






model$call[["random"]]




library(nlme)
library(Matrix)

XX <- get_matrices_from_lmer(model1)
YY <- get_full_covariance_lme(model)

t(XX$Zt)

as(YY$Z, "sparseMatrix")







model  <- lmer(distance ~ Sex + (1|Subject) + (age-1|Subject), data=orth, REML=F)


image(get_vary(model))


max(abs(get_SigmaG(model)$Sigma - get_vary(model)))


get_vary(model)  |> as("sparseMatrix")



var.d <- crossprod(getME(model,"Lambdat"))
Zt <- getME(model,"Zt")
vr <- sigma(model)^2

var.b <- vr*(t(Zt) %*% var.d %*% Zt)
sI <- vr * Diagonal(ncol(Zt))
var.y <- var.b + sI



get_matrices_from_lmer <- function(model){
    var.d <- crossprod(getME(model,"Lambdat"))
    Zt <- getME(model,"Zt")
    vr <- sigma(model)^2
    
    G <- vr * var.d
    ZGZt <- t(Zt) %*% G %*% Zt
    R <- vr * Diagonal(ncol(Zt))
    var.y <- ZGZt + R
    
    list(Zt=Zt, G=G, R=R)
}


var.y





















model  <- lmer(distance ~ age*Sex + (age|Subject), data=Orthodont)

# Extract covariance parameters
sigma2 <- sigma(model)^2                 # Residual variance
cor_params <- coef(model$modelStruct$corStruct, unconstrained = FALSE)  # Correlation parameter

# Print parameters
cat("Residual variance (sigma^2):", sigma2, "\n")
cat("Correlation parameter (rho):", cor_params, "\n")

# Construct the full covariance matrix
C <- corMatrix(model$modelStruct$corStruct)
V <- sigma2 * as.matrix(bdiag(C))

# Print the covariance matrix
print(V)


Lt <- getME(lmm_fit1, "Lambdat")

t(Lt) %*% Lt


# Fit the lmer model
lmm_fit <- lmer(wear ~ type + (1 | boy), data = shoes_long)

# Extract components
Z <- as.matrix(getME(lmm_fit, "Z"))              # Random effects design matrix
sigma2 <- sigma(lmm_fit)^2                       # Residual variance
G <- matrix(VarCorr(lmm_fit)$boy[1], 1, 1)       # Random effects variance

# Compute covariance matrix
ZGZt <- Z %*% G %*% t(Z)                         # Contribution from random effects
Sigma_y <- ZGZt + sigma2 * diag(nrow(Z))         # Add residual variance

# Convert to sparse matrix (optional)
library(Matrix)
Sigma_y_sparse <- as(Sigma_y, "sparseMatrix")

# Print result
print(Sigma_y_sparse)


model <- lmm_fit


library(lme4)
library(Matrix)


library(lme4)
library(Matrix)

orth <- Orthodont[c(1:12, 97:108),] 

model  <- lmer(distance ~ age*Sex + (1|Subject) + (age-1|Subject), data=orth)
get_matrices_from_lmer(model)
get_SigmaG(model)$Sigma

model  <- lmer(distance ~ age*Sex + (1|Subject) , data=orth)
out <- get_matrices_from_lmer(model)
get_SigmaG(model)$Sigma

get_matrices_from_lmer(model)

library(lme4)
library(Matrix)



pbkrtest::get_SigmaG(model)$Sigma


```
