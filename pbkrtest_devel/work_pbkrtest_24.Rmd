---
title: "Untitled"
author: "Søren Højsgaard"
date: "`r Sys.Date()`"
format: 
  html: 
    toc: true
    number-sections: true
---

\def\cov{Cov}
\def\corr{Corr}
\def\var{Var}
\def\nn{\nonumber}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
options("digits"=4)
```

\def\fixme#1{{\color{red}#1}}

## Preliminaries

To carry out the examples in this note, make sure the following packages from CRAN are installed: lme4, nlme, SASmixed,

```{r print=F}
library(lme4)
library(nlme)
library(SASmixed)
library(doBy)
library(dataRep)
library(tidyr)
library(ggplot2)
library(pbkrtest)
library(knitr)
library(broom.mixed)
```

## Shoes

The shoes data are measurements of the amount wear of the soles of shoes worn by 10 boys. The soles were made to two different synthetic materials, a standard material A and a cheaper material B. Data is taken from Box, Hunter, Hunter (2005) Statistics for Experimenters, 2nd edition Wiley, p. 81.
```{r}
data(shoes, package="doBy")
shoes_comp <- shoes
kable(shoes_comp)
```


```{r}
shoes$A[1:2] <- NA
shoes$B[3] <- NA
kable(shoes)
```


```{r}
shoes_long <-
    shoes |> pivot_longer(cols=c("A", "B"), names_to="type", values_to = "wear")
shoes_long <- na.omit(shoes_long)
kable(shoes_long)

```


```{r} 
shoes_long |> ggplot(aes(boy, wear, color=type)) + geom_point()
```

The plot shows that there is a large boy-to-boy variation in wear, and a much smaller variation between the two materials. The general tendency is that the wear of material B is larger than the wear of material A. Since the profiles are roughly parallel, there is no indication of interaction between boy and type. 

It is reasonable to assume that the boys are independent, but that the wear of the two materials are correlated: A boy with high weat of material A is likely to have high wear of material B etc. This is supported by the correlation between the wear of the two materials:

```{r}
cor(shoes[, c("A","B")], use="pairwise.complete.obs")
```

### The paired $t$--test


One question to ask: Is material B significantly worse than material A? This can be answered by a paired $t$--test: Simply subtract the wear of material A from the wear of material B and test if the mean is different from zero. This way we get around the problem of repeated measurements on the same boy: We transform the problem into a problem that can be handled by standard statistical methods.



```{r}
## Maybe not tidy()
with(shoes, t.test(A, B), var.equal=T) |> tidy()
with(shoes, t.test(A, B, paired=T), var.equal=T) |> tidy()
with(shoes, t.test(A - B)) |> tidy()
lm(A - B ~ 1, data=shoes) |> tidy()
```

This is not appropriate: The paired $t$--test assumes that the differences are independent and identically distributed. This is not the case here: The differences are correlated. The paired $t$--test is not valid in this case.

```{r}
with(shoes, t.test(A, B), var.equal=T) |> tidy()
```



### Working with linear models 
One might be tempted to analyze data with a linear model with material (and boy) as effects:

```{r}
lm_fit1 <- lm(wear ~ type, data=shoes_long)
lm_fit2 <- lm(wear ~ type + boy, data=shoes_long) 
lm_fit3 <- lm(B ~ A, data = shoes)
```

For both models, the estimated difference between the two materials is the same, but the standard errors differ by an order of magnitude:

```{r}
lm_fit1 |> tidy()
lm_fit2 |> tidy()
lm_fit3 |> tidy()
```


The same is the case for the residual standard deviation:

```{r}
lm_fit1 |> glance()
lm_fit2 |> glance()
```

Under one model, there is absolutely no evidence of effect of materials, while under the other model, the effect is highly significant:

```{r}
anova(lm_fit1)
anova(lm_fit2)
```

Another question one might ask is what is the wear of each material "in general". For one model this is just intercept for material A and intercept + effect for material B. For the model with boy as a factor, one option is to calculate the prediction based for an "average boy", which means adding the average of each boy to the intercept for material A and B. Such a quantity is called a least squares mean (LSmean):

```{r}
LSmeans(lm_fit1, ~type)  ## FIXME output is bad
LSmeans(lm_fit2, ~type)
```


### Mixed models

We fit models to the two datasets:

```{r}
lmm_fit1  <- lmer( wear ~ type + (1|boy), data=shoes_long )
lmm_fit0  <- update( lmm_fit1, .~. - type)
```

```{r}
lmm_fit1 |> tidy()
```


```{r}
load_all("_pbkrtest")
an <- anova(lmm_fit1, lmm_fit0, test="Chisq" ) 
an
str(an)
anova(lmm_fit1, update(lmm_fit1, .~.-type), test="Chisq" ) 

krb <- KRmodcomp(lmm_fit1, .~.-type)
ss <- summary( krb )
krb
ss

load_all("_pbkrtest")
satb <- SATmodcomp(lmm_fit1, .~.-type)
ss <- summary(satb)
satb
satb$p.value
ss

pbb <- PBmodcomp(lmm_fit1, .~. - type)
ss <- summary(pbb) 
ss

pbb <- PBmodcomp(lmm_fit1, .~. - type, nsim=10)
ss <- summary(pbb) 
ss

load_all("_pbkrtest")
apbb <- seqPBmodcomp(lmm_fit1, update(lmm_fit1,.~. - type))
ass <- summary(apbb) 
apbb
apbb$p.value
ass

pbb$p.value
```


```{r}
source("nlme.R")
data("Orthodont")

mm1 <- lme(distance ~ age, random = ~ age | Subject, 
                 correlation = corAR1(form = ~ 1 | Subject), data = Orthodont, method="ML")

mm1 <- lme(distance ~ age, random = ~ age | Subject, 
                 data = Orthodont, method="ML")
mm0 <- update(mm1, .~.-age)

PBrefdist(mm1,mm0)

sm <- mm0
lg <- mm1


```
