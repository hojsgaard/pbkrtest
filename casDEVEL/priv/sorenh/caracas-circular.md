

```r
install_github("r-cas/caracas")
```

```
## Skipping install of 'caracas' from a github remote, the SHA1 (12d78283) has not changed since last install.
##   Use `force = TRUE` to force installation
```

```r
library(caracas)
```

## Cholesky
Write x ~ AR(1) as system of regressions. Gives
e = L x


```r
d  <- 5

## AR(1) as regressions
L.ar <- diag_("1", d)
L.ar[cbind(2:d, 1:(d-1))] <- "-a"
L.ar
```

```
## [caracas]: ⎡1   0   0   0   0⎤
##            ⎢                 ⎥
##            ⎢-a  1   0   0   0⎥
##            ⎢                 ⎥
##            ⎢0   -a  1   0   0⎥
##            ⎢                 ⎥
##            ⎢0   0   -a  1   0⎥
##            ⎢                 ⎥
##            ⎣0   0   0   -a  1⎦
```

```r
## Wrap around
L2.loop <- L.ar
L2.loop[1, d] <- "-a"
```

Variance of x (assuming Var(e)=I) under AR(1)


```r
L.ari <- inv(L.ar)
L.ari
```

```
## [caracas]: ⎡1   0   0   0  0⎤
##            ⎢                ⎥
##            ⎢a   1   0   0  0⎥
##            ⎢                ⎥
##            ⎢ 2              ⎥
##            ⎢a   a   1   0  0⎥
##            ⎢                ⎥
##            ⎢ 3   2          ⎥
##            ⎢a   a   a   1  0⎥
##            ⎢                ⎥
##            ⎢ 4   3   2      ⎥
##            ⎣a   a   a   a  1⎦
```

```r
V1 <- L.ari %*% t(L.ari)
V1 ## Variance
```

```
## [caracas]: ⎡                   2               3                   4          ⎤
##            ⎢1      a          a               a                   a           ⎥
##            ⎢                                                                  ⎥
##            ⎢     2           3              4    2               5    3       ⎥
##            ⎢a   a  + 1      a  + a         a  + a               a  + a        ⎥
##            ⎢                                                                  ⎥
##            ⎢ 2   3        4    2          5    3              6    4    2     ⎥
##            ⎢a   a  + a   a  + a  + 1     a  + a  + a         a  + a  + a      ⎥
##            ⎢                                                                  ⎥
##            ⎢ 3   4    2   5    3        6    4    2         7    5    3       ⎥
##            ⎢a   a  + a   a  + a  + a   a  + a  + a  + 1    a  + a  + a  + a   ⎥
##            ⎢                                                                  ⎥
##            ⎢ 4   5    3   6    4    2   7    5    3       8    6    4    2    ⎥
##            ⎣a   a  + a   a  + a  + a   a  + a  + a  + a  a  + a  + a  + a  + 1⎦
```

```r
K1 <- t(L.ar) %*% L.ar
K1 ## Concentration
```

```
## [caracas]: ⎡ 2                                ⎤
##            ⎢a  + 1    -a      0       0     0 ⎥
##            ⎢                                  ⎥
##            ⎢         2                        ⎥
##            ⎢  -a    a  + 1    -a      0     0 ⎥
##            ⎢                                  ⎥
##            ⎢                 2                ⎥
##            ⎢  0       -a    a  + 1    -a    0 ⎥
##            ⎢                                  ⎥
##            ⎢                         2        ⎥
##            ⎢  0       0       -a    a  + 1  -a⎥
##            ⎢                                  ⎥
##            ⎣  0       0       0       -a    1 ⎦
```

Variance of x (assuming Var(e)=I) under "wrap"


```r
L2.loopi <- inv(L2.loop)
L2.loopi
```

```
## [caracas]: ⎡           4       3       2          ⎤
##            ⎢  1       a       a       a       a   ⎥
##            ⎢──────  ──────  ──────  ──────  ──────⎥
##            ⎢     5       5       5       5       5⎥
##            ⎢1 - a   1 - a   1 - a   1 - a   1 - a ⎥
##            ⎢                                      ⎥
##            ⎢                   4       3       2  ⎥
##            ⎢  a       1       a       a       a   ⎥
##            ⎢──────  ──────  ──────  ──────  ──────⎥
##            ⎢     5       5       5       5       5⎥
##            ⎢1 - a   1 - a   1 - a   1 - a   1 - a ⎥
##            ⎢                                      ⎥
##            ⎢   2                       4       3  ⎥
##            ⎢  a       a       1       a       a   ⎥
##            ⎢──────  ──────  ──────  ──────  ──────⎥
##            ⎢     5       5       5       5       5⎥
##            ⎢1 - a   1 - a   1 - a   1 - a   1 - a ⎥
##            ⎢                                      ⎥
##            ⎢   3       2                       4  ⎥
##            ⎢  a       a       a       1       a   ⎥
##            ⎢──────  ──────  ──────  ──────  ──────⎥
##            ⎢     5       5       5       5       5⎥
##            ⎢1 - a   1 - a   1 - a   1 - a   1 - a ⎥
##            ⎢                                      ⎥
##            ⎢   4       3       2                  ⎥
##            ⎢  a       a       a       a       1   ⎥
##            ⎢──────  ──────  ──────  ──────  ──────⎥
##            ⎢     5       5       5       5       5⎥
##            ⎣1 - a   1 - a   1 - a   1 - a   1 - a ⎦
```

```r
V2 <- L2.loopi %*% t(L2.loopi)
V2 ## Variance
```

```
## [caracas]: ⎡     8           6           4           2                      7           5
##            ⎢    a           a           a           a           1          a           a 
##            ⎢───────── + ───────── + ───────── + ───────── + ─────────  ───────── + ──────
##            ⎢        2           2           2           2           2          2         
##            ⎢⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     
##            ⎢⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a
##            ⎢                                                                             
##            ⎢     7           5           4           3                      8           6
##            ⎢    a           a           a           a           a          a           a 
##            ⎢───────── + ───────── + ───────── + ───────── + ─────────  ───────── + ──────
##            ⎢        2           2           2           2           2          2         
##            ⎢⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     
##            ⎢⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a
##            ⎢                                                                             
##            ⎢     6           5           4           3           2          7           5
##            ⎢    a           a           a           a           a          a           a 
##            ⎢───────── + ───────── + ───────── + ───────── + ─────────  ───────── + ──────
##            ⎢        2           2           2           2           2          2         
##            ⎢⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     
##            ⎢⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a
##            ⎢                                                                             
##            ⎢     6           5           4           3           2          6           5
##            ⎢    a           a           a           a           a          a           a 
##            ⎢───────── + ───────── + ───────── + ───────── + ─────────  ───────── + ──────
##            ⎢        2           2           2           2           2          2         
##            ⎢⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     
##            ⎢⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a
##            ⎢                                                                             
##            ⎢     7           5           4           3                      6           5
##            ⎢    a           a           a           a           a          a           a 
##            ⎢───────── + ───────── + ───────── + ───────── + ─────────  ───────── + ──────
##            ⎢        2           2           2           2           2          2         
##            ⎢⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     
##            ⎣⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a
##            
##                       4           3                      6           5           4       
##                      a           a           a          a           a           a        
##            ─── + ───────── + ───────── + ─────────  ───────── + ───────── + ───────── + ─
##              2           2           2           2          2           2           2    
##            5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛
##             ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝
##                                                                                          
##                       4           2                      7           5           4       
##                      a           a           1          a           a           a        
##            ─── + ───────── + ───────── + ─────────  ───────── + ───────── + ───────── + ─
##              2           2           2           2          2           2           2    
##            5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛
##             ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝
##                                                                                          
##                       4           3                      8           6           4       
##                      a           a           a          a           a           a        
##            ─── + ───────── + ───────── + ─────────  ───────── + ───────── + ───────── + ─
##              2           2           2           2          2           2           2    
##            5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛
##             ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝
##                                                                                          
##                       4           3           2          7           5           4       
##                      a           a           a          a           a           a        
##            ─── + ───────── + ───────── + ─────────  ───────── + ───────── + ───────── + ─
##              2           2           2           2          2           2           2    
##            5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛
##             ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝
##                                                                                          
##                       4           3           2          6           5           4       
##                      a           a           a          a           a           a        
##            ─── + ───────── + ───────── + ─────────  ───────── + ───────── + ───────── + ─
##              2           2           2           2          2           2           2    
##            5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛
##             ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝
##            
##                3           2          6           5           4           3           2  
##               a           a          a           a           a           a           a   
##            ──────── + ─────────  ───────── + ───────── + ───────── + ───────── + ────────
##                   2           2          2           2           2           2           
##                 5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞
##            1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠
##                                                                                          
##                3                      6           5           4           3           2  
##               a           a          a           a           a           a           a   
##            ──────── + ─────────  ───────── + ───────── + ───────── + ───────── + ────────
##                   2           2          2           2           2           2           
##                 5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞
##            1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠
##                                                                                          
##                2                      7           5           4           3              
##               a           1          a           a           a           a           a   
##            ──────── + ─────────  ───────── + ───────── + ───────── + ───────── + ────────
##                   2           2          2           2           2           2           
##                 5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞
##            1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠
##                                                                                          
##                3                      8           6           4           2              
##               a           a          a           a           a           a           1   
##            ──────── + ─────────  ───────── + ───────── + ───────── + ───────── + ────────
##                   2           2          2           2           2           2           
##                 5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞
##            1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠
##                                                                                          
##                3           2          7           5           4           3              
##               a           a          a           a           a           a           a   
##            ──────── + ─────────  ───────── + ───────── + ───────── + ───────── + ────────
##                   2           2          2           2           2           2           
##                 5⎞    ⎛     5⎞   ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞
##            1 - a ⎠    ⎝1 - a ⎠   ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠
##            
##                    7           5           4           3               ⎤
##                   a           a           a           a           a    ⎥
##            ─  ───────── + ───────── + ───────── + ───────── + ─────────⎥
##            2          2           2           2           2           2⎥
##               ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞ ⎥
##               ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠ ⎥
##                                                                        ⎥
##                    6           5           4           3           2   ⎥
##                   a           a           a           a           a    ⎥
##            ─  ───────── + ───────── + ───────── + ───────── + ─────────⎥
##            2          2           2           2           2           2⎥
##               ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞ ⎥
##               ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠ ⎥
##                                                                        ⎥
##                    6           5           4           3           2   ⎥
##                   a           a           a           a           a    ⎥
##            ─  ───────── + ───────── + ───────── + ───────── + ─────────⎥
##            2          2           2           2           2           2⎥
##               ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞ ⎥
##               ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠ ⎥
##                                                                        ⎥
##                    7           5           4           3               ⎥
##                   a           a           a           a           a    ⎥
##            ─  ───────── + ───────── + ───────── + ───────── + ─────────⎥
##            2          2           2           2           2           2⎥
##               ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞ ⎥
##               ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠ ⎥
##                                                                        ⎥
##                    8           6           4           2               ⎥
##                   a           a           a           a           1    ⎥
##            ─  ───────── + ───────── + ───────── + ───────── + ─────────⎥
##            2          2           2           2           2           2⎥
##               ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞    ⎛     5⎞ ⎥
##               ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠    ⎝1 - a ⎠ ⎦
```

```r
K2 <- t(L2.loop) %*% L2.loop
K2 ## Concentration
```

```
## [caracas]: ⎡ 2                                    ⎤
##            ⎢a  + 1    -a      0       0       -a  ⎥
##            ⎢                                      ⎥
##            ⎢         2                            ⎥
##            ⎢  -a    a  + 1    -a      0       0   ⎥
##            ⎢                                      ⎥
##            ⎢                 2                    ⎥
##            ⎢  0       -a    a  + 1    -a      0   ⎥
##            ⎢                                      ⎥
##            ⎢                         2            ⎥
##            ⎢  0       0       -a    a  + 1    -a  ⎥
##            ⎢                                      ⎥
##            ⎢                                 2    ⎥
##            ⎣  -a      0       0       -a    a  + 1⎦
```

```r
## How different are the log-likelihoods?

## Wishart matrix
S <- nxn_matrix(d, "s", sym=T)    

logL.ar   <- det(K1) - sum(diag(K1 %*% S))
logL.wrap <- det(K2) - sum(diag(K2 %*% S))

logL.ar - logL.wrap
```

```
## [caracas]:    10      5                 ⎛ 2    ⎞      
##            - a   + 2⋅a  - 2⋅a⋅s₅₁ + s₅₅⋅⎝a  + 1⎠ - s₅₅
```

```r
## #' Simplification of L2.loopi and V2: get rid of denominator
## L2.loopi

den <- as_sym2(expression(1-a^d), list(d=d))
S2i <- L2.loopi * den 

V2.prop <- S2i %*% t(S2i)
V2.prop
```

```
## [caracas]: ⎡ 8    6    4    2        7    5    4    3        6    5    4    3    2   6   
##            ⎢a  + a  + a  + a  + 1   a  + a  + a  + a  + a   a  + a  + a  + a  + a   a  + 
##            ⎢                                                                             
##            ⎢ 7    5    4    3        8    6    4    2        7    5    4    3        6   
##            ⎢a  + a  + a  + a  + a   a  + a  + a  + a  + 1   a  + a  + a  + a  + a   a  + 
##            ⎢                                                                             
##            ⎢ 6    5    4    3    2   7    5    4    3        8    6    4    2        7   
##            ⎢a  + a  + a  + a  + a   a  + a  + a  + a  + a   a  + a  + a  + a  + 1   a  + 
##            ⎢                                                                             
##            ⎢ 6    5    4    3    2   6    5    4    3    2   7    5    4    3        8   
##            ⎢a  + a  + a  + a  + a   a  + a  + a  + a  + a   a  + a  + a  + a  + a   a  + 
##            ⎢                                                                             
##            ⎢ 7    5    4    3        6    5    4    3    2   6    5    4    3    2   7   
##            ⎣a  + a  + a  + a  + a   a  + a  + a  + a  + a   a  + a  + a  + a  + a   a  + 
##            
##             5    4    3    2   7    5    4    3     ⎤
##            a  + a  + a  + a   a  + a  + a  + a  + a ⎥
##                                                     ⎥
##             5    4    3    2   6    5    4    3    2⎥
##            a  + a  + a  + a   a  + a  + a  + a  + a ⎥
##                                                     ⎥
##             5    4    3        6    5    4    3    2⎥
##            a  + a  + a  + a   a  + a  + a  + a  + a ⎥
##                                                     ⎥
##             6    4    2        7    5    4    3     ⎥
##            a  + a  + a  + 1   a  + a  + a  + a  + a ⎥
##                                                     ⎥
##             5    4    3        8    6    4    2     ⎥
##            a  + a  + a  + a   a  + a  + a  + a  + 1 ⎦
```

```r
## Sanity check
(V2.prop / (den^2) - V2)  %>% simplify()
```

```
## [caracas]: ⎡0  0  0  0  0⎤
##            ⎢             ⎥
##            ⎢0  0  0  0  0⎥
##            ⎢             ⎥
##            ⎢0  0  0  0  0⎥
##            ⎢             ⎥
##            ⎢0  0  0  0  0⎥
##            ⎢             ⎥
##            ⎣0  0  0  0  0⎦
```

```r
## den <- as_sym2("1-a^d", list(d=d))


 
## Alternative
## K1. <- inv(V1) %>% simplify()
## max(abs(as_expr(K1 - K1.)))
## This inversion takes time:
## K2. <- inv(V2)  %>% simplify()  
## max(abs(as_expr(K2 - K2.)))
```

